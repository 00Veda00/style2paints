require=function e(t,n,i){function o(a,d){if(!n[a]){if(!t[a]){var l="function"==typeof require&&require;if(!d&&l)return l(a,!0);if(r)return r(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var s=n[a]={exports:{}};t[a][0].call(s.exports,function(e){var n=t[a][1][e];return o(n?n:e)},s,s.exports,e,t,n,i)}return n[a].exports}for(var r="function"==typeof require&&require,a=0;a<i.length;a++)o(i[a]);return o}({Controller:[function(e,t,n){"use strict";function i(e){return void 0!==window.URL?window.URL.createObjectURL(e):window.webkitURL.createObjectURL(e)}function o(e){l(i(e.target.files[0]))}function r(e){a(i(e.target.files[0]))}function a(e){var t=document.getElementById("tempDivReference");if(null===t){var t=document.createElement("div");document.body.appendChild(t),t.style.position="absolute",t.id="tempDivReference",t.innerHTML="<img id=imgheadReference>",t.style.display="none",t.style.visibility="hidden"}var n=document.getElementById("imgheadReference");n.onload=function(){var e=s.spriteFrame.getTexture();e._pixels=[],e.initWithElement(this),e.handleLoadedTexture();var t=parseFloat(this.width),n=parseFloat(this.height);t<n?(t=200/n*t,n=200):(n=200/t*n,t=200),s.node.width=parseInt(t),s.node.height=parseInt(n),L=!0},n.src=e}function d(e){var t=document.getElementById("tempDivResult");if(null===t){var t=document.createElement("div");document.body.appendChild(t),t.style.position="absolute",t.id="tempDivResult",t.innerHTML="<img id=imgheadResult>",t.style.display="none",t.style.visibility="hidden"}var n=document.getElementById("imgheadResult");n.onload=function(){var e=h.spriteFrame.getTexture();e._pixels=[],e.initWithElement(this),e.handleLoadedTexture();var t=parseFloat(this.width),n=parseFloat(this.height),i=!0;t>n?t>724&&(i=!1):n>724&&(i=!1),i||(t<n?(t=724/n*t,n=724):(n=724/t*n,t=724)),h.node.width=parseInt(t),h.node.height=parseInt(n)},n.src=e}function l(e){var t=document.getElementById("tempDivSketch");if(null===t){var t=document.createElement("div");document.body.appendChild(t),t.style.position="absolute",t.id="tempDivSketch",t.innerHTML="<img id=imgheadSketch>",t.style.display="none",t.style.visibility="hidden"}var n=document.getElementById("imgheadSketch");n.onload=function(){var e=c.spriteFrame.getTexture();e._pixels=[],e.initWithElement(this),e.handleLoadedTexture();var t=parseFloat(this.width),n=parseFloat(this.height);t<n?(t=512/n*t,n=512):(n=512/t*n,t=512),c.node.width=parseInt(t),c.node.height=parseInt(n),p.width=c.node.width,p.height=c.node.height,x.width=c.node.width,x.height=c.node.height;var i=x.getContext("2d");i.clearRect(0,0,x.width,x.height);var o=p.getComponent("cc.Sprite").spriteFrame.getTexture();o.initWithElement(x),o.handleLoadedTexture(),k=!0},n.src=e}cc._RF.push(t,"806bcYbxcNFYKpTMgw+5/TX","Controller");var c,s,h,u,p,g,m,f,v,y,x,w=!1,C=!1,b=!1,I=!1,T=!1,R=!1,E=0,F=0,k=!1,L=!1,S=!0,D=!1,_="",U=!1,P=0;cc.Texture2D.prototype._pixels=[],cc.Texture2D.prototype.getPixels=function(e,t,n,i){if(!this._pixels||0==this._pixels.length){var o=document.createElement("canvas");o.width=n,o.height=i;var r=o.getContext("2d"),a=this.getHtmlElementObj();r.drawImage(a,0,0,n,i),this._pixels=r.getImageData(0,0,n,i).data}var d=parseInt((i-parseInt(t))*n*4+4*parseInt(e));return new cc.color(this._pixels[d],this._pixels[d+1],this._pixels[d+2])},cc.Class({"extends":cc.Component,properties:{sketchImg:{"default":null,type:cc.Node},referenceImg:{"default":null,type:cc.Node},resultImg:{"default":null,type:cc.Node},colorImg:{"default":null,type:cc.Node},flag:{"default":null,type:cc.Node},hint:{"default":null,type:cc.Node},btn:{"default":null,type:cc.Node}},onLoad:function(){cc.renderer.enableDirtyRegion(!1),c=this.sketchImg.getComponent("cc.Sprite"),s=this.referenceImg.getComponent("cc.Sprite"),h=this.resultImg.getComponent("cc.Sprite"),u=this.colorImg.getComponent("cc.Sprite"),p=this.hint,g=this.btn.getComponent("cc.Button"),m=this.btn.getComponent("cc.RichText"),f=document.createElement("input"),f.id="fileInputForSketch",f.type="file",f.accept="image/*",f.style.height="0px",f.style.display="block",f.style.overflow="hidden",document.body.insertBefore(f,document.body.firstChild),f.addEventListener("change",o,!1),v=document.createElement("input"),v.id="fileInputForReferene",v.type="file",v.accept="image/*",v.style.height="0px",v.style.display="block",v.style.overflow="hidden",document.body.insertBefore(v,document.body.firstChild),v.addEventListener("change",r,!1),this.node.on("mousemove",function(e){y=e.getLocation()}),this.node.on("mousedown",function(e){D=!0}),this.node.on("mouseup",function(e){b=!0,D=!1}),x=document.createElement("canvas"),x.id="hintcan",C=!0},onSketchClicked:function(){f.click()},onRefenceClicked:function(){v.click()},onPenClicked:function(){S=!0},onEraserClicked:function(){S=!1},onClearClicked:function(){var e=x.getContext("2d");e.clearRect(0,0,x.width,x.height);var t=p.getComponent("cc.Sprite").spriteFrame.getTexture();t.initWithElement(x),t.handleLoadedTexture()},onColorizeClicked:function(){if(L&&k){var e=document.createElement("canvas"),t=c.spriteFrame.getTexture(),n=parseFloat(t.width),i=parseFloat(t.height);e.width=n,e.height=i;var o=e.getContext("2d");o.drawImage(t.getHtmlElementObj(),0,0,n,i);var r=e.toDataURL("image/png");t=s.spriteFrame.getTexture();var n=parseFloat(t.width),i=parseFloat(t.height);n>i?(n=512/i*n,i=512):(i=512/n*i,n=512),e.width=n,e.height=i;var o=e.getContext("2d");o.drawImage(t.getHtmlElementObj(),0,0,n,i);var a=e.toDataURL("image/png"),l=x.toDataURL("image/png"),h=new XMLHttpRequest;h.open("POST","/paint",!0),h.setRequestHeader("Content-Type","application/x-www-form-urlencoded;"),h.onreadystatechange=function(){_="data:image/png;base64,"+h.responseText,d(_),g.enabled=!0,m.string="<u>colorize</u>"},h.send("sketch="+encodeURIComponent(r)+"&reference="+encodeURIComponent(a)+"&hint="+encodeURIComponent(l)),g.enabled=!1,m.string="Waiting"}},onDownloadClicked:function(){if(""!=_){var e=window.open("about:blank","image");e.document.write("<img src='"+_+"' alt='from canvas'/>")}},onTitle:function(){window.open("https://github.com/lllyasviel/style2paints","gitHub")},handlePainter:function(){R=!1;var e=0,t=0,n=c.node.convertToWorldSpace(c.node.position);if(null!=n&&null!=y){var i=n.x-256,o=n.y-256;e=y.x-i,t=y.y-o;var r=e>0&&t>0&&e<c.node.width&&t<c.node.height;r&&(R=!0)}if(R&&D){var a=x.getContext("2d");if(S){a.beginPath(),a.arc(e,c.node.height-t,3,0,2*Math.PI,!0),a.closePath();var d=u.node.color;a.fillStyle="rgba("+d.r.toString()+","+d.g.toString()+","+d.b.toString()+",0.5)",a.fill()}else{var a=x.getContext("2d");a.clearRect(e-10,c.node.height-t-10,20,20)}var l=p.getComponent("cc.Sprite").spriteFrame.getTexture();l.initWithElement(x),l.handleLoadedTexture()}},handleColorPicker:function(){var e=s.node.convertToWorldSpace(s.node.position);if(null!=e&&null!=y){var t=e.x,n=e.y,i=y.x-t,o=y.y-n;if(w=i>0&&o>0&&i<s.node.width&&o<s.node.height)I||(T=!0),b&&T&&(this.flag.x=i-s.node.width/2,this.flag.y=o-s.node.height/2,E=i,F=o,S=!0);else if(T){T=!1;s.spriteFrame.getTexture();u.node.color=s.spriteFrame.getTexture().getPixels(E,F,s.node.width,s.node.height)}if(T){s.spriteFrame.getTexture();u.node.color=s.spriteFrame.getTexture().getPixels(i,o,s.node.width,s.node.height)}}},update:function(e){C&&(this.handleColorPicker(),this.handlePainter(),T?document.body.style.cursor="crosshair":R?document.body.style.cursor="crosshair":document.body.style.cursor="default",U&&(P+=1,m.string="Wait 5 minutes: "+(1e4-P))),I=w,b=!1}}),cc._RF.pop()},{}]},{},["Controller"]);