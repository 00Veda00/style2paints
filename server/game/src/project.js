require=function e(t,n,i){function o(a,d){if(!n[a]){if(!t[a]){var l="function"==typeof require&&require;if(!d&&l)return l(a,!0);if(r)return r(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var s=n[a]={exports:{}};t[a][0].call(s.exports,function(e){var n=t[a][1][e];return o(n?n:e)},s,s.exports,e,t,n,i)}return n[a].exports}for(var r="function"==typeof require&&require,a=0;a<i.length;a++)o(i[a]);return o}({Controller:[function(e,t,n){"use strict";function i(e){return void 0!==window.URL?window.URL.createObjectURL(e):window.webkitURL.createObjectURL(e)}function o(e){l(i(e.target.files[0]))}function r(e){a(i(e.target.files[0]))}function a(e){var t=document.getElementById("tempDivReference");if(null===t){var t=document.createElement("div");document.body.appendChild(t),t.style.position="absolute",t.id="tempDivReference",t.innerHTML="<img id=imgheadReference>",t.style.display="none",t.style.visibility="hidden"}var n=document.getElementById("imgheadReference");n.onload=function(){var e=parseFloat(this.width),t=parseFloat(this.height);e>t?(e=224/t*e,t=224):(t=224/e*t,e=224);var n=parseFloat(this.width),i=parseFloat(this.height);n<i?(n=200/i*n,i=200):(i=200/n*i,n=200),s.node.width=parseInt(n),s.node.height=parseInt(i),x.width=parseInt(e),x.height=parseInt(t),x.getContext("2d").drawImage(this,0,0,x.width,x.height),C.getContext("2d").clearRect(0,0,C.width,C.height);var o=s.spriteFrame.getTexture(),r=u.getComponent("cc.Sprite").spriteFrame.getTexture();r.initWithElement(C),r.handleLoadedTexture(),o.initWithElement(x),o.handleLoadedTexture();var a=document.createElement("canvas");a.width=parseInt(n),a.height=parseInt(i),a.getContext("2d").drawImage(this,0,0,a.width,a.height),o._pixels=a.getContext("2d").getImageData(0,0,a.width,a.height).data,D=!0},n.src=e}function d(e){var t=document.getElementById("tempDivResult");if(null===t){var t=document.createElement("div");document.body.appendChild(t),t.style.position="absolute",t.id="tempDivResult",t.innerHTML="<img id=imgheadResult>",t.style.display="none",t.style.visibility="hidden"}var n=document.getElementById("imgheadResult");n.onload=function(){var e=h.spriteFrame.getTexture();e.initWithElement(this),e.handleLoadedTexture();var t=parseFloat(this.width),n=parseFloat(this.height),i=!0;t>n?t>724&&(i=!1):n>724&&(i=!1),i||(t<n?(t=724/n*t,n=724):(n=724/t*n,t=724)),h.node.width=parseInt(t),h.node.height=parseInt(n)},n.src=e}function l(e){var t=document.getElementById("tempDivSketch");if(null===t){var t=document.createElement("div");document.body.appendChild(t),t.style.position="absolute",t.id="tempDivSketch",t.innerHTML="<img id=imgheadSketch>",t.style.display="none",t.style.visibility="hidden"}var n=document.getElementById("imgheadSketch");n.onload=function(){var e=parseFloat(this.width),t=parseFloat(this.height);e>t?(e=512/t*e,t=512):(t=512/e*t,e=512),w.width=parseInt(e),w.height=parseInt(t),C.width=parseInt(e),C.height=parseInt(t),e=parseFloat(this.width),t=parseFloat(this.height),e<t?(e=512/t*e,t=512):(t=512/e*t,e=512),c.node.width=parseInt(e),c.node.height=parseInt(t),u.width=parseInt(e),u.height=parseInt(t),w.getContext("2d").drawImage(this,0,0,w.width,w.height),C.getContext("2d").clearRect(0,0,C.width,C.height);var n=u.getComponent("cc.Sprite").spriteFrame.getTexture();n.initWithElement(C),n.handleLoadedTexture();var i=c.spriteFrame.getTexture();i.initWithElement(w),i.handleLoadedTexture(),S=!0},n.src=e}cc._RF.push(t,"806bcYbxcNFYKpTMgw+5/TX","Controller");var c,s,h,p,u,g,m,f,v,y,w,x,C,I=!1,F=!1,b=!1,T=!1,R=!1,E=!1,L=0,k=0,S=!1,D=!1,_=!0,U=!1,P="";cc.Texture2D.prototype._pixels=[],cc.Texture2D.prototype.getPixels=function(e,t,n,i){var o=parseInt((i-parseInt(t))*n*4+4*parseInt(e));return new cc.color(this._pixels[o],this._pixels[o+1],this._pixels[o+2])},cc.Class({"extends":cc.Component,properties:{sketchImg:{"default":null,type:cc.Node},referenceImg:{"default":null,type:cc.Node},resultImg:{"default":null,type:cc.Node},colorImg:{"default":null,type:cc.Node},flag:{"default":null,type:cc.Node},hint:{"default":null,type:cc.Node},btn:{"default":null,type:cc.Node}},onLoad:function(){c=this.sketchImg.getComponent("cc.Sprite"),s=this.referenceImg.getComponent("cc.Sprite"),h=this.resultImg.getComponent("cc.Sprite"),p=this.colorImg.getComponent("cc.Sprite"),u=this.hint,g=this.btn.getComponent("cc.Button"),m=this.btn.getComponent("cc.RichText"),f=document.createElement("input"),f.id="fileInputForSketch",f.type="file",f.accept="image/*",f.style.height="0px",f.style.display="block",f.style.overflow="hidden",document.body.insertBefore(f,document.body.firstChild),f.addEventListener("change",o,!1),v=document.createElement("input"),v.id="fileInputForReferene",v.type="file",v.accept="image/*",v.style.height="0px",v.style.display="block",v.style.overflow="hidden",document.body.insertBefore(v,document.body.firstChild),v.addEventListener("change",r,!1),this.node.on("mousemove",function(e){y=e.getLocation()}),this.node.on("mousedown",function(e){U=!0}),this.node.on("mouseup",function(e){b=!0,U=!1}),C=document.createElement("canvas"),C.id="HTML_Canvas_hint",x=document.createElement("canvas"),x.id="HTML_Canvas_reference",w=document.createElement("canvas"),w.id="HTML_Canvas_sketch",F=!0},onSketchClicked:function(){f.click()},onRefenceClicked:function(){v.click()},onPenClicked:function(){_=!0},onEraserClicked:function(){_=!1},onClearClicked:function(){var e=C.getContext("2d");e.clearRect(0,0,C.width,C.height);var t=u.getComponent("cc.Sprite").spriteFrame.getTexture();t.initWithElement(C),t.handleLoadedTexture()},onColorizeClicked:function(){if(D&&S){var e=C.toDataURL("image/png"),t=x.toDataURL("image/png"),n=w.toDataURL("image/png"),i=new XMLHttpRequest;i.open("POST","/paint",!0),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded;"),i.onreadystatechange=function(){P="data:image/png;base64,"+i.responseText,d(P),g.enabled=!0,m.string="<u>colorize</u>"},i.send("sketch="+encodeURIComponent(n)+"&reference="+encodeURIComponent(t)+"&hint="+encodeURIComponent(e)),g.enabled=!1,m.string="Waiting"}},onDownloadClicked:function(){if(""!=P){var e=window.open("about:blank","image");e.document.write("<img src='"+P+"' alt='from canvas'/>")}},onTitle:function(){window.open("https://github.com/lllyasviel/style2paints","gitHub")},handlePainter:function(){E=!1;var e=0,t=0,n=c.node.convertToWorldSpace(c.node.position);if(null!=n&&null!=y){var i=n.x-256,o=n.y-256;e=y.x-i,t=y.y-o;var r=e>0&&t>0&&e<c.node.width&&t<c.node.height;r&&(E=!0)}if(E&&U){var a=C.getContext("2d");if(_){a.beginPath(),a.arc(parseInt(parseFloat(e)/parseFloat(c.node.width)*parseFloat(w.width)),parseInt(parseFloat(c.node.height-t)/parseFloat(c.node.height)*parseFloat(w.height)),5,0,2*Math.PI,!0),a.closePath();var d=p.node.color;a.fillStyle="rgba("+d.r.toString()+","+d.g.toString()+","+d.b.toString()+",0.618)",a.fill()}else{var a=C.getContext("2d");a.clearRect(parseInt(parseFloat(e)/parseFloat(c.node.width)*parseFloat(w.width))-10,parseInt(parseFloat(c.node.height-t)/parseFloat(c.node.height)*parseFloat(w.height))-10,20,20)}var l=u.getComponent("cc.Sprite").spriteFrame.getTexture();l.initWithElement(C),l.handleLoadedTexture(!0)}},handleColorPicker:function(){var e=s.node.convertToWorldSpace(s.node.position);if(null!=e&&null!=y){var t=e.x,n=e.y,i=y.x-t,o=y.y-n;if(I=i>0&&o>0&&i<s.node.width&&o<s.node.height)T||(R=!0),b&&R&&(this.flag.x=i-s.node.width/2,this.flag.y=o-s.node.height/2,L=i,k=o,_=!0);else if(R){R=!1;s.spriteFrame.getTexture();p.node.color=s.spriteFrame.getTexture().getPixels(L,k,s.node.width,s.node.height)}if(R){s.spriteFrame.getTexture();p.node.color=s.spriteFrame.getTexture().getPixels(i,o,s.node.width,s.node.height)}}},update:function(e){F&&(this.handleColorPicker(),this.handlePainter(),R?document.body.style.cursor="crosshair":E?document.body.style.cursor="crosshair":document.body.style.cursor="default"),T=I,b=!1}}),cc._RF.pop()},{}]},{},["Controller"]);